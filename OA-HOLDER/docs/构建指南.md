# 构建和打包指南

## 构建命令说明

### 开发模式
```bash
npm run dev
```
启动开发服务器和 Electron 应用

### 构建生产版本
```bash
npm run build
```
构建渲染进程和主进程代码（不打包）

### 打包应用

#### 1. 打包所有平台（生产环境）
```bash
npm run dist
```
根据 package.json 中的配置打包所有平台，自动根据版本号创建输出文件夹

#### 2. 打包 RE 环境
```bash
npm run dist:re
```
打包 RE 预发布环境版本

#### 3. 打包 Windows 32位和64位（生产环境）
```bash
npm run dist:win
```
同时生成 32位（ia32）和 64位（x64）的 Windows 安装包

#### 4. 仅打包 Windows 32位（生产环境）
```bash
npm run dist:win32
```
只生成 32位（ia32）的 Windows 安装包

#### 5. 仅打包 Windows 64位（生产环境）
```bash
npm run dist:win64
```
只生成 64位（x64）的 Windows 安装包

#### 6. RE 环境 Windows 打包命令
```bash
npm run dist:re:win      # 32位和64位
npm run dist:re:win32    # 仅32位
npm run dist:re:win64    # 仅64位
```
打包 RE 环境的 Windows 版本

## 输出文件说明

### 版本号文件夹管理

打包完成后，文件会**自动根据版本号**输出到 `release/v{version}/` 目录。

例如，如果当前版本是 `1.0.1`，打包文件会输出到 `release/v1.0.1/` 目录。

**目录结构示例：**
```
release/
├── v1.0.0/              # 版本 1.0.0 的打包文件
│   ├── holder Setup 1.0.0-x64.exe
│   ├── holder Setup 1.0.0-ia32.exe
│   └── ...
├── v1.0.1/              # 版本 1.0.1 的打包文件
│   ├── holder Setup 1.0.1-x64.exe
│   ├── holder Setup 1.0.1-ia32.exe
│   └── ...
└── v1.1.0/              # 版本 1.1.0 的打包文件
    └── ...
```

**优势：**
- ✅ 每个版本的打包文件独立存放，便于管理
- ✅ 避免版本文件覆盖，保留历史版本
- ✅ 清晰的版本目录结构，方便查找和分发

### Windows 安装包文件说明

在版本号文件夹内，包含以下文件：

- **NSIS 安装程序**：
  - `holder Setup x.x.x-x64.exe` - 64位安装程序
  - `holder Setup x.x.x-ia32.exe` - 32位安装程序
  
- **便携版（Portable）**：
  - `holder x.x.x-x64.exe` - 64位便携版
  - `holder x.x.x-ia32.exe` - 32位便携版

- **解压目录**：
  - `win-unpacked/` - 64位解压文件
  - `win-ia32-unpacked/` - 32位解压文件

- **其他文件**：
  - `latest.yml` - 更新检查文件
  - `*.exe.blockmap` - 增量更新文件

## 图标配置

### Windows 图标
在项目根目录创建 `build/` 目录，并放置以下图标文件：

- `build/icon.ico` - Windows 图标文件（推荐尺寸：256x256 或 512x512）

### 图标生成工具
可以使用以下工具生成图标：
- [ICO Convert](https://icoconvert.com/)
- [CloudConvert](https://cloudconvert.com/png-to-ico)
- [RealWorld Icon Editor](http://www.rw-designer.com/)

### 图标要求
- **格式**：`.ico` 文件
- **尺寸**：建议 256x256 或 512x512 像素
- **位置**：`build/icon.ico`

如果没有图标文件，electron-builder 会使用默认图标。

## NSIS 安装程序配置

当前配置的安装程序特性：
- ✅ 允许用户选择安装目录
- ✅ 创建桌面快捷方式
- ✅ 创建开始菜单快捷方式
- ✅ 非一键安装（显示安装向导）

如需修改，编辑 `package.json` 中的 `build.nsis` 配置。

## 版本号管理

### 版本号格式

版本号在 `package.json` 的 `version` 字段中定义，格式为：`主版本号.次版本号.修订号`

例如：`1.0.0`、`1.0.1`、`1.1.0`

### 如何更新版本号

1. 编辑 `package.json` 文件
2. 修改 `version` 字段的值
3. 运行打包命令，会自动创建对应版本号的文件夹

**示例：**
```json
{
  "version": "1.0.1"  // 修改版本号
}
```

```bash
npm run dist  # 打包后文件会输出到 release/v1.0.1/
```

### 自动版本文件夹

打包脚本会自动读取 `package.json` 中的版本号，并创建对应的输出文件夹：
- 版本 `1.0.0` → 输出到 `release/v1.0.0/`
- 版本 `1.0.1` → 输出到 `release/v1.0.1/`
- 版本 `2.0.0` → 输出到 `release/v2.0.0/`

**注意：** 每次打包都会根据当前版本号创建新的文件夹，不会覆盖之前的版本。

## 常见问题

### 1. 打包时提示找不到图标
**解决方案**：创建 `build/icon.ico` 文件，或从配置中移除 `icon` 字段

### 2. 打包文件过大
**解决方案**：
- 检查 `build.files` 配置，排除不必要的文件
- 使用 `build.compression` 设置压缩级别

### 3. 32位打包失败
**解决方案**：确保系统支持 32位构建，某些 Electron 版本可能不再支持 32位架构

### 4. 打包速度慢
**解决方案**：
- 使用 `--dir` 参数只生成解压目录，不打包安装程序
- 分别打包 32位和 64位，而不是同时打包

## 高级配置

### 只生成解压目录（不打包安装程序）
```bash
npm run build && electron-builder --win --x64 --ia32 --dir
```

### 自定义输出目录

**注意：** 项目已配置为自动根据版本号创建输出文件夹。如需自定义，可以修改 `scripts/build-with-version.js` 脚本中的输出目录逻辑。

默认配置会自动创建 `release/v{version}/` 格式的文件夹。如需修改格式，编辑脚本文件：
```javascript
// scripts/build-with-version.js
const outputDir = `release/v${version}`;  // 修改这里的格式
```

### 排除文件
在 `package.json` 中添加：
```json
"build": {
  "files": [
    "dist/**/*",
    "package.json",
    "!**/node_modules/**/*",
    "!**/*.map"
  ]
}
```

