# 打包脚本说明

## 概述

项目使用自定义打包脚本 `scripts/build-with-version.js` 来实现基于版本号的自动文件夹管理。

## 工作原理

1. **读取版本号**：脚本自动读取 `package.json` 中的 `version` 字段
2. **创建版本文件夹**：根据版本号创建 `release/v{version}/` 格式的输出目录
3. **传递配置**：通过临时配置文件将输出目录传递给 electron-builder
4. **清理临时文件**：打包完成后自动删除临时配置文件

## 脚本位置

```
scripts/
└── build-with-version.js    # 打包脚本
```

## 使用方法

所有打包命令都已集成版本号文件夹功能：

```bash
# 生产环境
npm run dist              # 打包所有平台
npm run dist:win          # Windows 32位和64位
npm run dist:win32        # Windows 32位
npm run dist:win64        # Windows 64位

# RE 环境
npm run dist:re           # 打包所有平台（RE环境）
npm run dist:re:win       # Windows（RE环境）
npm run dist:re:win32     # Windows 32位（RE环境）
npm run dist:re:win64     # Windows 64位（RE环境）
```

## 输出目录结构

```
release/
├── v1.0.0/                    # 版本 1.0.0 的打包文件
│   ├── holder Setup 1.0.0-x64.exe
│   ├── holder Setup 1.0.0-ia32.exe
│   ├── holder 1.0.0-x64.exe
│   ├── holder 1.0.0-ia32.exe
│   ├── win-unpacked/
│   ├── win-ia32-unpacked/
│   └── ...
├── v1.0.1/                    # 版本 1.0.1 的打包文件
│   └── ...
└── v1.1.0/                    # 版本 1.1.0 的打包文件
    └── ...
```

## 版本号格式

版本号遵循 [语义化版本](https://semver.org/) 规范：

- **主版本号**：不兼容的 API 修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

示例：`1.0.0`、`1.0.1`、`1.1.0`、`2.0.0`

## 更新版本号

1. 编辑 `package.json`
2. 修改 `version` 字段
3. 运行打包命令，会自动创建对应版本号的文件夹

```json
{
  "version": "1.0.1"  // 修改这里
}
```

```bash
npm run dist  # 自动创建 release/v1.0.1/ 文件夹
```

## 自定义输出目录格式

如需修改输出目录的格式，编辑 `scripts/build-with-version.js`：

```javascript
// 默认格式：release/v{version}
const outputDir = `release/v${version}`;

// 可以修改为其他格式，例如：
// const outputDir = `release/${version}`;           // release/1.0.1/
// const outputDir = `release/version-${version}`;    // release/version-1.0.1/
// const outputDir = `dist/${version}`;               // dist/1.0.1/
```

## 技术实现

脚本使用以下技术：

1. **Node.js 文件系统 API**：读取 `package.json` 和创建临时配置文件
2. **child_process.execSync**：执行 electron-builder 命令
3. **临时配置文件**：通过 `electron-builder.temp.json` 传递配置

## 注意事项

1. **临时文件**：脚本会创建 `electron-builder.temp.json` 临时文件，打包完成后自动删除
2. **版本号必需**：确保 `package.json` 中存在有效的 `version` 字段
3. **Git 忽略**：临时配置文件已添加到 `.gitignore`，不会被提交到版本控制

## 故障排除

### 问题：打包失败，提示找不到版本号

**解决方案**：检查 `package.json` 中是否存在 `version` 字段

### 问题：输出目录没有按版本号创建

**解决方案**：
1. 检查脚本文件是否存在：`scripts/build-with-version.js`
2. 确认使用的是正确的打包命令（使用 `npm run dist` 而不是直接调用 `electron-builder`）

### 问题：临时配置文件没有被删除

**解决方案**：手动删除 `electron-builder.temp.json` 文件，脚本会在下次运行时自动清理

## 相关文件

- `scripts/build-with-version.js` - 打包脚本
- `package.json` - 版本号和打包命令配置
- `.gitignore` - 临时文件忽略配置

